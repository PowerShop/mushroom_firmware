# üîÑ Hybrid Mode - Two-Way Sync Summary

## üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö

‡∏£‡∏∞‡∏ö‡∏ö **Hybrid Mode (Mode 2)** ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö **Two-Way Synchronization**:
- üîµ **‡∏ö‡∏≠‡∏£‡πå‡∏î ‚Üí API**: ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
- üî¥ **API ‚Üí ‡∏ö‡∏≠‡∏£‡πå‡∏î**: ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

---

## üéØ ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Two-Way Sync

### 1Ô∏è‚É£ ‡∏ö‡∏≠‡∏£‡πå‡∏î ‚Üí API (‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏õ Database)

#### **‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:**

**A. ‡∏Å‡∏î‡∏à‡∏≤‡∏Å‡∏à‡∏≠‡∏ö‡∏≠‡∏£‡πå‡∏î (Touch Screen)**
```cpp
[‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏≠] 
    ‚Üí [UI ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Open_relay() / Close_relay()]
    ‚Üí [RelayStatus[i] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
    ‚Üí [PUT /api/switch/{id}] ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    ‚Üí [Database ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï]
```

**B. ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡πà‡∏≤‡∏ô MQTT**
```cpp
[Web/App ‡∏™‡πà‡∏á MQTT] 
    ‚Üí [@private/led0-3]
    ‚Üí [ControlRelay_Bymanual()]
    ‚Üí [Open_relay() / Close_relay()]
    ‚Üí [updateSwitchStateToAPI()] ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    ‚Üí [PUT /api/switch/{id}]
    ‚Üí [Database ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï]
```

**C. Timer ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥**
```cpp
[‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î] 
    ‚Üí [ControlRelay_Bytimmer()]
    ‚Üí [RelayStatus[i] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
    ‚Üí [syncAllRelaysToAPI()] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    ‚Üí [PUT /api/switch/{id}]
    ‚Üí [Database ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï]
```

**D. Sensor ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥**
```cpp
[Sensor ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î] 
    ‚Üí [ControlRelay_BysoilMinMax() / BytempMinMax()]
    ‚Üí [RelayStatus[i] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
    ‚Üí [syncAllRelaysToAPI()] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    ‚Üí [PUT /api/switch/{id}]
    ‚Üí [Database ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï]
```

---

### 2Ô∏è‚É£ API ‚Üí ‡∏ö‡∏≠‡∏£‡πå‡∏î (‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Database)

**‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ:**
```cpp
[syncSwitchStatesFromAPI()] ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    ‚Üì
[GET /api/switch] ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á 4 switches
    ‚Üì
[‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö lastKnownSwitchStates[]]
    ‚Üì
[‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á]
    ‚Üì
[‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Relay Hardware]
    - Open_relay(i) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö state = ON
    - Close_relay(i) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö state = OFF
    ‚Üì
[‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å lastKnownSwitchStates[] ‡πÉ‡∏´‡∏°‡πà]
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Log:**
```
[INFO] Switch 1 changed: OFF -> ON
[DEBUG] Relay 0 turned ON
```

---

## ‚öôÔ∏è Configuration

### ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î
```cpp
// ‡πÉ‡∏ô HandySense.cpp (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ~189)
#define USE_SWITCH_API_CONTROL  2  // Hybrid Mode

// ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ:
// 0 = MQTT Only (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ API)
// 1 = API Only (API ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á)
// 2 = Hybrid (Two-Way Sync)
```

### ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
```cpp
// ‡πÉ‡∏ô SwitchApiClient.h (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ~20)
#define SWITCH_POLL_INTERVAL    1000  // 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (1000ms)
```

### API Endpoint
```cpp
#define SWITCH_API_BASE_URL     "http://203.159.93.240"
#define SWITCH_API_ENDPOINT     "/api/switch"
#define SWITCH_API_KEY          "DD5B523CF73EF3386DB2DE4A7AEDD"
```

---

## üîÑ Flow Diagram ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Switch (4 ‡∏ß‡∏¥‡∏ò‡∏µ)              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. ‡∏à‡∏≠‡∏ö‡∏≠‡∏£‡πå‡∏î (Touch Screen)                     ‚îÇ
‚îÇ  2. MQTT (@private/led0-3)                     ‚îÇ
‚îÇ  3. Timer (‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤)                           ‚îÇ
‚îÇ  4. Sensor (‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ Relay Hardware  ‚îÇ ‚Üê ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡∏à‡∏£‡∏¥‡∏á
         ‚îÇ (O1, O2, O3, O4)‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì      ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ ‡∏™‡πà‡∏á API ‚îÇ    ‚îÇ ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å API  ‚îÇ
    ‚îÇ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ   ‚îÇ    ‚îÇ ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì              ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  PUT /api/switch/{id}      ‚îÇ
    ‚îÇ  GET /api/switch           ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  .NET API Server     ‚îÇ
    ‚îÇ  203.159.93.240      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  MySQL Database      ‚îÇ
    ‚îÇ  table: switch       ‚îÇ
    ‚îÇ  (id, name, state,   ‚îÇ
    ‚îÇ   update_at)         ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚Üë
               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Web Application     ‚îÇ
    ‚îÇ  (‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Real-time) ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

### Scenario 1: ‡∏Å‡∏î‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö

```
[Web] ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î Switch 1 ‡πÄ‡∏õ‡πá‡∏ô ON
    ‚Üì
[Web] ‡∏™‡πà‡∏á HTTP Request: PUT /api/switch/1 {"state": "on"}
    ‚Üì
[API] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Database: switch.id=1, state='on'
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ: GET /api/switch
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö Switch 1 ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å OFF ‚Üí ON
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] Open_relay(0)
    ‚Üì
[Hardware] Relay 1 ‡πÄ‡∏õ‡∏¥‡∏î! üí°
```

**‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:** ~1-2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏£‡∏ß‡∏° network latency)

---

### Scenario 2: ‡∏Å‡∏î‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡∏à‡∏≤‡∏Å‡∏à‡∏≠‡∏ö‡∏≠‡∏£‡πå‡∏î

```
[‡∏à‡∏≠‡∏ö‡∏≠‡∏£‡πå‡∏î] ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Switch 2
    ‚Üì
[UI] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Open_relay(1)
    ‚Üì
[Hardware] Relay 2 ‡πÄ‡∏õ‡∏¥‡∏î! üí° (‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] updateSwitchStateToAPI(2, 1)
    ‚Üì
[API] PUT /api/switch/2 {"state": "on"}
    ‚Üì
[Database] switch.id=2, state='on' ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    ‚Üì
[Web] ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‚Üí ‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ON ‚úÖ
```

**‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:** Relay ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ, API sync ‡πÉ‡∏ô ~100-300ms

---

### Scenario 3: Timer ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

```
[‡πÄ‡∏ß‡∏•‡∏≤] ‡πÄ‡∏ß‡∏•‡∏≤ 18:00 ‡∏ô. ‡∏ñ‡∏∂‡∏á
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] ControlRelay_Bytimmer() ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] RelayStatus[2] = 1 (‡πÄ‡∏õ‡∏¥‡∏î Relay 3)
    ‚Üì
[Hardware] Relay 3 ‡πÄ‡∏õ‡∏¥‡∏î! üí°
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] syncAllRelaysToAPI() ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] ‡∏™‡πà‡∏á PUT /api/switch/3 {"state": "on"}
    ‚Üì
[Database] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    ‚Üì
[Web] ‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Real-time ‚úÖ
```

---

### Scenario 4: Sensor ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°

```
[Sensor] ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ = 32¬∞C (‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î 30¬∞C)
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] ControlRelay_BytempMinMax() ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] RelayStatus[3] = 1 (‡πÄ‡∏õ‡∏¥‡∏î‡∏û‡∏±‡∏î‡∏•‡∏°)
    ‚Üì
[Hardware] Relay 4 ‡πÄ‡∏õ‡∏¥‡∏î! üí°
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] syncAllRelaysToAPI() ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    ‚Üì
[‡∏ö‡∏≠‡∏£‡πå‡∏î] ‡∏™‡πà‡∏á PUT /api/switch/4 {"state": "on"}
    ‚Üì
[Database] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    ‚Üì
[Web] ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏û‡∏±‡∏î‡∏•‡∏°‡πÄ‡∏õ‡∏¥‡∏î + ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚úÖ
```

---

## üé® Serial Monitor Logs

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:
```
[INFO] Initializing Switch Manager (Mode 2)...
[INFO] Synced states from API
[INFO] API switch 1 state: OFF, Relay 0 state: OFF
[INFO] API switch 2 state: ON, Relay 1 state: OFF
[INFO] API switch 3 state: OFF, Relay 2 state: OFF
[INFO] API switch 4 state: OFF, Relay 3 state: OFF
[INFO] Hybrid Mode: MQTT/Timer/Sensor control relay, changes sync to API
```

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠ API ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:
```
[INFO] Switch 2 changed: OFF -> ON
[DEBUG] Relay 1 turned ON
```

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
```
[INFO] MQTT ON relay 0 -> Updating API switch 1
[INFO] Updated switch 1 to API: ON
```

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Timer/Sensor ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:
```
[INFO] Relay 2 changed to 1, syncing to API...
[INFO] Updated switch 3 to API: ON
```

---

## ‚ö° Performance

### Build Results:
- ‚úÖ **RAM Usage:** 40.8% (133,768 / 327,680 bytes)
- ‚úÖ **Flash Usage:** 44.2% (1,476,629 / 3,342,336 bytes)
- ‚úÖ **Build Time:** ~85 seconds
- ‚úÖ **Status:** SUCCESS

### Network Usage:
- **‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** GET request ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (~200 bytes)
- **‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** PUT request ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (~150 bytes)
- **Total:** ~1.7 MB/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ö‡πà‡∏≠‡∏¢)

---

## üîç Troubleshooting

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å API

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö `USE_SWITCH_API_CONTROL = 2`
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö WiFi ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
3. ‡∏î‡∏π Serial Monitor ‡∏°‡∏µ log `syncSwitchStatesFromAPI()` ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
4. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡∏î‡πâ‡∏ß‡∏¢ Postman: `GET http://203.159.93.240/api/switch`

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
```cpp
// ‡∏•‡∏î interval ‡πÉ‡∏ô SwitchApiClient.h
#define SWITCH_POLL_INTERVAL    500  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Conflict ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°

**‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:**
- ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô MQTT + Web)
- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
- ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞ (Last Write Wins)

---

## üìö ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢

### ‚úÖ ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á Hybrid Mode:

1. **Two-Way Sync** - ‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏á‡∏ó‡∏≤‡∏á
2. **Real-time** - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
3. **‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô** - ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á
4. **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢** - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏°‡∏≠
5. **‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Real-time** - ‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

### üéØ ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°:

- ‚úÖ **‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö/‡πÅ‡∏≠‡∏õ** ‚Üí ‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1-2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
- ‚úÖ **‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏£‡πå‡∏î** ‚Üí ‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
- ‚úÖ **Timer/Sensor ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥** ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
- ‚úÖ **‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Real-time** ‚Üí ‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡πá‡∏ö

---

**üöÄ ‡∏û‡∏£‡πâ‡∏≠‡∏° Upload ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!**

**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:** 
- ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å API ‡∏ó‡∏∏‡∏Å **1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ**
- ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏õ API **‡∏ó‡∏±‡∏ô‡∏ó‡∏µ** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
